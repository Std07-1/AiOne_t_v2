<!DOCTYPE html>
<html lang="ua">

<head>
    <meta charset="UTF-8" />
    <title>AiOne Dashboard</title>
    <!-- TradingView —Å–∫—Ä–∏–ø—Ç -->
    <script src="https://s3.tradingview.com/tv.js"></script>
    <style>
        /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Reset & –±–∞–∑–æ–≤—ñ —Å—Ç–∏–ª—ñ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body,
        html {
            height: 100%;
            width: 100%;
            font-family: sans-serif;
            background: #0e1017;
            color: #eee;
            overflow: hidden;
        }

        body {
            display: flex;
        }

        /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –°—ñ—Ç–∫–∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        #sidebar {
            width: 280px;
            background: #131620;
            border-right: 1px solid #272b33;
            overflow-y: auto;
            padding: 1rem;
        }

        #content {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            position: relative;
        }

        /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –§—ñ–ª—å—Ç—Ä–∏ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        .filters {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .filters button {
            background: #1e2128;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 3px;
            cursor: pointer;
            transition: background .2s;
        }

        .filters button.active,
        .filters button:hover {
            background: #272b33;
        }

        /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –ö–∞—Ä—Ç–æ—á–∫–∞ –∞–∫—Ç–∏–≤—É ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        .asset {
            position: relative;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #272b33;
            cursor: pointer;
            transition: background .3s, transform .1s;
        }

        .asset:hover {
            transform: translateY(-2px);
        }

        .asset.selected {
            background: #272b33;
        }

        .asset-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .asset-symbol {
            font-weight: bold;
            font-size: 1.1rem;
            color: #7aa2f7;
        }

        .asset-price {
            font-size: 1.1rem;
            min-width: 80px;
            text-align: right;
        }

        .asset-change {
            margin-left: 0.5rem;
            font-size: 0.9rem;
        }

        .up {
            color: #3bbf7b;
        }

        .down {
            color: #f7768e;
        }

        .asset-badge {
            margin-left: 0.5rem;
            cursor: help;
            font-size: 1rem;
        }

        .asset-score {
            height: 6px;
            border-radius: 3px;
            background: #272b33;
            overflow: hidden;
            margin-top: 6px;
        }

        .asset-score>div {
            height: 100%;
            background: linear-gradient(90deg, #3bbf7b, #7aa2f7);
            transition: width .3s;
        }

        .tv-sparkline {
            margin-top: 6px;
        }

        .asset-hint {
            margin-top: 4px;
            font-size: 0.75rem;
            color: #8a8f99;
        }

        /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –ü–∞–Ω–µ–ª—å –¥–µ—Ç–∞–ª–µ–π ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        #detail {
            background: #1e2128;
            padding: 1rem;
            border-radius: 4px;
            display: none;
        }

        #detail h2 {
            margin-bottom: 0.5rem;
            color: #7aa2f7;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 0.4rem 0;
            border-bottom: 1px solid #272b33;
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-key {
            color: #8a8f99;
        }

        .detail-value {
            text-align: right;
        }

        /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –¢–í-–≥—Ä–∞—Ñ—ñ–∫ –≤ –¥–µ—Ç–∞–ª—è—Ö ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        #tv_chart {
            width: 100%;
            height: 400px;
            margin-bottom: 1rem;
        }

        /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –ö–Ω–æ–ø–∫–∞ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        #settings-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: #1e2128;
            border: none;
            padding: 0.5rem;
            border-radius: 3px;
            cursor: pointer;
        }

        /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        #settings-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        #settings-content {
            background: #1e2128;
            padding: 1.5rem;
            border-radius: 5px;
            width: 300px;
        }

        #settings-content h3 {
            margin-bottom: 1rem;
        }

        .setting-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .setting-item label {
            flex: 1;
            cursor: pointer;
        }

        .setting-item input[type="range"] {
            width: 60px;
            margin-left: 0.5rem;
        }

        #settings-actions {
            text-align: right;
            margin-top: 1rem;
        }

        #settings-actions button {
            background: #272b33;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 3px;
            cursor: pointer;
            margin-left: 0.5rem;
        }
    </style>
</head>

<body>

    <!-- –°–∞–π–¥–±–∞—Ä -->
    <div id="sidebar">
        <div class="filters">
            <button data-filter="all" class="active">All</button>
            <button data-filter="hot">üî• Hot</button>
            <button data-filter="rsi">RSI‚Üë</button>
        </div>
        <!-- Card list -->
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
    <div id="content">
        <button id="settings-btn" title="–ù–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç">‚öôÔ∏è</button>
        <h1>–ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ –∞–∫—Ç–∏–≤—ñ–≤</h1>
        <div id="last-updated" style="margin-bottom:1rem; font-size:0.9rem; color:#8a8f99;"></div>
        <!-- TradingView Chart -->
        <div id="tv_chart"></div>
        <div id="detail"></div>
    </div>

    <!-- –ú–æ–¥–∞–ª–∫–∞ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å -->
    <div id="settings-modal">
        <div id="settings-content">
            <h3>–ö—Ä–∏—Ç–µ—Ä—ñ—ó –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç—É</h3>
            <!-- –ø–µ—Ä–µ–±—ñ—Ä –∫–ª—é—á—ñ–≤ -->
            <div class="setting-item">
                <input type="checkbox" id="f_rsi"><label for="f_rsi">RSI</label>
                <input type="range" id="w_rsi" min="0" max="100">
            </div>
            <div class="setting-item">
                <input type="checkbox" id="f_open_interest"><label for="f_open_interest">Open Interest</label>
                <input type="range" id="w_open_interest" min="0" max="100">
            </div>
            <div class="setting-item">
                <input type="checkbox" id="f_price_change"><label for="f_price_change">Price Change</label>
                <input type="range" id="w_price_change" min="0" max="100">
            </div>
            <div class="setting-item">
                <input type="checkbox" id="f_volume_z"><label for="f_volume_z">Vol Z</label>
                <input type="range" id="w_volume_z" min="0" max="100">
            </div>
            <div class="setting-item">
                <input type="checkbox" id="f_correlation"><label for="f_correlation">Correlation</label>
                <input type="range" id="w_correlation" min="0" max="100">
            </div>
            <div id="settings-actions">
                <button id="cancel-settings">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                <button id="save-settings">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
            </div>
        </div>
    </div>

    <script>
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –ì–ª–æ–±–∞–ª—å–Ω—ñ –∑–º—ñ–Ω–Ω—ñ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let assets_data = [], settings = {};
        const sidebar = document.getElementById('sidebar');
        const detail = document.getElementById('detail');
        const last_up = document.getElementById('last-updated');

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è/–∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function load_settings() {
            const s = localStorage.getItem('priority_settings');
            if (s) settings = JSON.parse(s);
            else settings = {
                rsi: 20, open_interest: 20, price_change: 20, volume_z: 20, correlation: 20,
                enabled: { rsi: true, open_interest: true, price_change: true, volume_z: true, correlation: true }
            };
        }
        function save_settings() {
            localStorage.setItem('priority_settings', JSON.stringify(settings));
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –û–±—á–∏—Å–ª–µ–Ω–Ω—è score ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function compute_score(a) {
            let total = 0, sumw = 0;
            for (const key in settings.enabled) {
                if (!settings.enabled[key]) continue;
                const w = settings[key]; sumw += w;
                let val = 0;
                if (key === 'rsi') val = Math.abs(a.rsi - 50) / 50;
                if (key === 'open_interest') val = a.open_interest_norm;
                if (key === 'price_change') val = Math.abs(a.price_change);
                if (key === 'volume_z') val = a.volume_z_norm;
                if (key === 'correlation') val = Math.abs(a.correlation_with_index);
                total += val * w;
            }
            return sumw > 0 ? Math.round((total / sumw) * 100) : 0;
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è TradingView –¥–ª—è main chart ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function initMainChart(symbol) {
            new TradingView.widget({
                autosize: true,
                symbol: symbol + 'USDT',
                interval: '15',
                timezone: 'Etc/UTC',
                theme: 'dark',
                container_id: 'tv_chart'
            });
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –†–µ–Ω–¥–µ—Ä –∫–∞—Ä—Ç–∏ hint —É –∫–∞—Ä—Ç—Ü—ñ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function renderHints(hints) {
            return hints.map(h => {
                switch (h.type) {
                    case 'delta_hint':
                        return `${h.delta_percent > 0 ? '+' : ''}${h.delta_percent}% –∑–∞ ${h.timeframe}`;
                    case 'hint':
                        return `–ù–∞–±–ª–∏–∂–∞—î—Ç—å—Å—è –¥–æ ${h.level_type} ${h.level} (${h.distance_percent}% –∑–∞–ª–∏—à–∏–ª–æ—Å—å)`;
                    case 'user_alert':
                        return `–í–∞—à –∞–ª–µ—Ä—Ç: –¥–æ—Å—è–≥ ${h.target_price}`;
                    case 'alert_expiring':
                        return `–ê–ª–µ—Ä—Ç ${h.target_price} —Å–ø–ª–∏–≤–∞—î —á–µ—Ä–µ–∑ ${h.expires_in}`;
                }
            }).join(' ‚Ä¢ ');
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –†–µ–Ω–¥–µ—Ä —Å–ø–∏—Å–∫—É –∞–∫—Ç–∏–≤—ñ–≤ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function render_list(filter = 'all') {
            // –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ –∫–∞—Ä—Ç–æ—á–∫–∏
            sidebar.querySelectorAll('.asset').forEach(el => el.remove());
            // –Ω–æ—Ä–º–∞–ª—ñ–∑–∞—Ü—ñ—è –¥–ª—è OI –π Vol Z
            const maxOI = Math.max(...assets_data.map(a => a.open_interest));
            const minV = Math.min(...assets_data.map(a => a.volume_z)), maxV = Math.max(...assets_data.map(a => a.volume_z));
            assets_data.forEach((a, i) => {
                a.open_interest_norm = a.open_interest / maxOI;
                a.volume_z_norm = maxV > minV ? (a.volume_z - minV) / (maxV - minV) : 0;
                a.priority_score = compute_score(a);
                // —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—è
                if (filter === 'hot' && a.priority_score < 75) return;
                if (filter === 'rsi' && a.rsi <= 60) return;

                // –∫–∞—Ä—Ç–æ—á–∫–∞
                const div = document.createElement('div');
                div.className = 'asset';
                div.dataset.idx = i;
                // heatmap
                const hue = Math.round((a.priority_score / 100) * 120);
                div.style.background = `hsl(${hue},50%,15%)`;

                div.innerHTML = `
          <div class="asset-header">
            <span class="asset-symbol">${a.symbol}</span>
            <span>
              <span class="asset-price">${a.price.toFixed(4)}</span>
              <span class="asset-change ${a.price_change >= 0 ? 'up' : 'down'}">
                ${(a.price_change * 100).toFixed(2)}%
              </span>
              <span class="asset-badge" title="${a.badge_desc}">${a.badge_icon}</span>
            </span>
          </div>
          <div class="tv-sparkline" id="tv-spark-${i}"></div>
          <div class="asset-score"><div style="width:${a.priority_score}%"></div></div>
          <div class="asset-hint">${renderHints(a.hints || [])}</div>
        `;
                div.addEventListener('click', () => select_asset(i));
                sidebar.appendChild(div);

                // —ñ–Ω—ñ—Ü—ñ—é—î–º–æ TradingView mini-chart
                new TradingView.widget({
                    autosize: false,
                    width: 100, height: 20,
                    symbol: a.symbol + 'USDT',
                    interval: '1',
                    theme: 'dark',
                    container_id: 'tv-spark-' + i
                });
            });
            if (assets_data.length) select_asset(0);
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –ü–æ–∫–∞–∑ –¥–µ—Ç–∞–ª–µ–π –∞–∫—Ç–∏–≤—É ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function select_asset(idx) {
            sidebar.querySelectorAll('.asset')
                .forEach((el, i) => el.classList.toggle('selected', i === idx));
            const a = assets_data[idx];
            detail.style.display = 'block';
            detail.innerHTML = `
        <h2>${a.symbol}
          <span class="${a.price_change >= 0 ? 'up' : 'down'}">
            ${a.price.toFixed(4)} (${(a.price_change * 100).toFixed(2)}%)
          </span>
        </h2>
        <div id="tv_chart"></div>
        ${['Volume (avg)', 'OI', 'RSI', 'ATR', 'Vol Z', 'Corr']
                    .map((k, j) => `
            <div class="detail-row">
              <div class="detail-key">${k}</div>
              <div class="detail-value">${[(a.volume / 1e6).toFixed(2) + 'M USD',
                        (a.open_interest / 1e6).toFixed(2) + 'M',
                        a.rsi.toFixed(1),
                        a.atr.toFixed(4),
                        a.volume_z.toFixed(2),
                        a.correlation_with_index.toFixed(2)
                        ][j]
                        }</div>
            </div>`).join('')}
        <div style="margin-top:0.75rem; font-size:0.85rem; color:#8a8f99;">
          <strong>–ü—Ä–∏—á–∏–Ω–∏:</strong> ${a.trigger_reasons.join(', ')}
        </div>
        <div style="margin-top:0.5rem; font-size:0.85rem; color:#8a8f99;">
          <strong>–ü—ñ–¥–∫–∞–∑–∫–∏:</strong> ${renderHints(a.hints || [])}
        </div>
      `;
            initMainChart(a.symbol);
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Fetch + –æ–Ω–æ–≤–ª–µ–Ω–Ω—è ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function fetch_data() {
            try {
                const res = await fetch('/api/data');
                const json = await res.json();
                assets_data = json.assets;
                last_up.textContent = 'Last update: ' + new Date(json.timestamp * 1000).toLocaleTimeString();
                const active = document.querySelector('.filters .active').dataset.filter;
                render_list(active);
            } catch (e) { console.error(e); }
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –§—ñ–ª—å—Ç—Ä–∏ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        document.querySelectorAll('.filters button').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelector('.filters .active').classList.remove('active');
                btn.classList.add('active');
                render_list(btn.dataset.filter);
            });
        });

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –º–æ–¥–∞–ª–∫–∏ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        document.getElementById('settings-btn').addEventListener('click', () => {
            for (const key of ['rsi', 'open_interest', 'price_change', 'volume_z', 'correlation']) {
                document.getElementById('f_' + key).checked = settings.enabled[key];
                document.getElementById('w_' + key).value = settings[key];
            }
            document.getElementById('settings-modal').style.display = 'flex';
        });
        document.getElementById('cancel-settings').addEventListener('click', () => {
            document.getElementById('settings-modal').style.display = 'none';
        });
        document.getElementById('save-settings').addEventListener('click', () => {
            for (const key of ['rsi', 'open_interest', 'price_change', 'volume_z', 'correlation']) {
                settings.enabled[key] = document.getElementById('f_' + key).checked;
                settings[key] = +document.getElementById('w_' + key).value;
            }
            save_settings();
            document.getElementById('settings-modal').style.display = 'none';
            const active = document.querySelector('.filters .active').dataset.filter;
            render_list(active);
        });

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –°—Ç–∞—Ä—Ç–æ–≤–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        load_settings();
        fetch_data();
        setInterval(fetch_data, 10000);
    </script>
</body>

</html>